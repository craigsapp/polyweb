
<script>
// vim: ts=3

var DATABASE = {};
var vrvToolkit = new verovio.toolkit();


///////////////////////////////
//
// prepareListOfWorks --
//

function prepareListOfWorks() {
	var request = new XMLHttpRequest();
	request.open("GET", "kern/list.txt");
	request.onreadystatechange = function() {
		if (this.readyState == 4 && this.status == 200) {
			processFileList(this.responseText);
		}
	};
	request.send();
}



//////////////////////////////
//
// processFileList --
//

function processFileList(text) {
	filelist = text.match(/[^\r\n]+/g);
	DATABASE = {};
	for (var i=0; i<filelist.length; i++) {
		var key = filelist[i];
		var filename = filelist[i];
		DATABASE[key] = {};
		DATABASE[key].filename = filename;
		var request = new XMLHttpRequest();
		request.open("GET", "kern/" + filename);
		(function(key) {
			request.onreadystatechange =
	   		function() {
	    			if (this.readyState == 4 && this.status == 200) {
						addFileToDatabase(key, this.responseText);
					}
				};
		})(key);
		request.send();
	}
}



//////////////////////////////
//
// addFileToDatabase --
//

function addFileToDatabase(key, kern) {
	if (kern.match(/^\s*$/)) {
		delete DATABASE[key];
		console.log("FILE", key, "is empty");
		return;
	}
	var lines = kern.match(/[^\r\n]+/g);
	var title = "";
	var composer = "";
	var matches;
	for (var i=0; i<lines.length; i++) {
		if (matches = lines[i].match(/^!!!OTL\s*:\s(.*)\s*$/)) {
			title = matches[1];
		}
		if (matches = lines[i].match(/^!!!COM\s*:\s(.*)\s*$/)) {
			composer = matches[1];
		}
	}
	DATABASE[key].title = title;
	DATABASE[key].composer = composer;
	DATABASE[key].kern = kern;

	// check to see if all scores have been downloaded, and then insert
	// into webpage.
	var ready = 1;
	for (var property in DATABASE) {
		if (!DATABASE[property].kern) {
			ready = 0;
		}
	}

	if (ready) {
		buildBrowseList();
	}
	
}


//////////////////////////////
//
// buildBrowseList --
//

function buildBrowseList() {
	var tsource = document.querySelector("#browse-template").textContent;
	var template = Handlebars.compile(tsource);
	var element = document.querySelector("#browse-list");
	element.innerHTML = template(DATABASE);
	addSvgImages();
}


//////////////////////////////
//
// addSvgImages --
//

function addSvgImages() {
	var options = {
		scale: 32,
		adjustPageHeight: 1,
		pageHeight: 20000,
		noHeader: 1,
		noFooter: 1,
		pageWidth: 3500
	};

	var kerns = document.querySelectorAll(".kern");
	for (var i=0; i<kerns.length; i++) {
		var data = kerns[i].textContent;
		var parent = kerns[i].parentNode;
		var svgslot = parent.querySelector("div.svg");
		var svgdata = vrvToolkit.renderData(data, options);
		svgslot.innerHTML = svgdata;
	}
}



</script>


